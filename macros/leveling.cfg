# ========================================================================
# SAFE HOME IF NEEDED
# ========================================================================

[gcode_macro AUTO_MESH]
description: Auto mesh using KAMP if available, fallback to bed_mesh_calibrate
gcode:
    {% if printer["gcode_macro _ADAPTIVE_MESH"] is defined %}
        { action_respond_info("KAMP Adaptive Mesh Active") }
        _ADAPTIVE_MESH
    {% else %}
        { action_respond_info("Running standard BED_MESH_CALIBRATE") }
        BED_MESH_CLEAR
        BED_MESH_CALIBRATE
    {% endif %}


[gcode_macro SAFE_HOME_IF_NEEDED]
description: Home only if not already homed
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
        M117 Homing...
        G28
    {% endif %}

# ========================================================================
# PROBE ACCURACY TEST
# ========================================================================
[gcode_macro PROBE_TEST]
description: Run probe accuracy test at center (TAP accuracy check)
gcode:
    SAFE_HOME_IF_NEEDED
    M117 Probe Accuracy Test...
    G1 X175 Y175 F12000
    PROBE_ACCURACY SAMPLES=10
    M117 Probe Test Done

# ========================================================================
# TAP FORCE TEST
# ========================================================================
[gcode_macro TAP_TEST]
description: TAP test at 3 corners + center
gcode:
    SAFE_HOME_IF_NEEDED
    M117 TAP Test...
    G1 X25 Y25 Z10 F12000
    PROBE_ACCURACY SAMPLES=5
    G1 X175 Y175 Z10 F12000
    PROBE_ACCURACY SAMPLES=5
    G1 X325 Y325 Z10 F12000
    PROBE_ACCURACY SAMPLES=5
    M117 TAP Test Done

# ========================================================================
# BELT TENSION TEST
# ========================================================================
[gcode_macro BELT_TENSION_TEST]
description: Resonance test for CoreXY belts
gcode:
    SAFE_HOME_IF_NEEDED
    M117 Belt Test...
    SHAPER_CALIBRATE AXIS=X
    SHAPER_CALIBRATE AXIS=Y
    M117 Belt Test Complete

# ========================================================================
# STEPPERS SANITY TEST
# ========================================================================
[gcode_macro STEPPERS_TEST]
description: Confirm X/Y/Z steppers move correctly
gcode:
    SAFE_HOME_IF_NEEDED
    M117 Stepper Test...
    G1 X20 Y20 Z10 F6000
    G1 X330 Y20 F9000
    G1 X330 Y330 F9000
    G1 X20 Y330 F9000
    G1 X20 Y20 F9000
    G1 Z50 F3000
    M117 Steppers OK

# ========================================================================
# MOTION TEST
# ========================================================================
[gcode_macro MOTION_TEST]
description: Move head around entire bed to confirm limits
gcode:
    SAFE_HOME_IF_NEEDED
    M117 Motion Test...
    G1 X10 Y10 F9000
    G1 X340 Y10 F9000
    G1 X340 Y340 F9000
    G1 X10 Y340 F9000
    G1 X175 Y175 F9000
    M117 Motion OK

# ========================================================================
# HEATED MESH
# ========================================================================
[gcode_macro MESH_SAFE]
description: Hot-bed mesh (cold nozzle)
gcode:
    {% set BED = params.BED|default(60)|float %}
    M117 Heated Mesh...
    M140 S{BED}
    M190 S{BED}
    M104 S0
    M106 S255
    G4 P8000
    M106 S0
    SAFE_HOME_IF_NEEDED
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE
    M117 Mesh Complete

# ========================================================================
# QGL SAFE
# ========================================================================
[gcode_macro QGL_SAFE]
description: Full safe QGL (heat bed + cool nozzle)
gcode:
    {% set BED = params.BED|default(60)|float %}
    M117 QGL Safe Mode...
    M140 S{BED}
    M190 S{BED}
    M104 S0
    M106 S255
    G4 P8000
    M106 S0
    SAFE_HOME_IF_NEEDED
    QUAD_GANTRY_LEVEL
    M117 QGL Done

# ========================================================================
# ðŸ”¥ QUICK TUNING MACROS â€” UNICORN BARF
# ========================================================================

[gcode_macro QGL60]
description: QGL only with bed at 60Â°C
gcode:
    G28
    M140 S60
    M190 S60
    _UNIBARF_COOL_FOR_PROBE
    G28 Z
    QUAD_GANTRY_LEVEL
    M117 QGL @ 60Â°C done

[gcode_macro QGL90]
description: QGL only with bed at 90Â°C
gcode:
    M140 S90
    M190 S90
    _UNIBARF_COOL_FOR_PROBE
    G28 Z
    QUAD_GANTRY_LEVEL
    M117 QGL @ 90Â°C done

[gcode_macro QGL100]
description: QGL only with bed at 100Â°C
gcode:
    M140 S100
    M190 S100
    _UNIBARF_COOL_FOR_PROBE
    G28 Z
    QUAD_GANTRY_LEVEL
    M117 QGL @ 100Â°C done

[gcode_macro PROBE60]
gcode:
    G28
    M117 Heating bed to 60C...
    M190 S60
    _UNIBARF_COOL_FOR_PROBE

    M117 Running Quad Gantry Level...
    QUAD_GANTRY_LEVEL

    M117 Running Mesh...
    AUTO_MESH

    M117 Full probe @ 60C complete



[gcode_macro PROBE90]
description: Full hot-bed probing @ 90Â°C
gcode:
    M140 S90
    M190 S90
    _UNIBARF_COOL_FOR_PROBE
    G28 Z
    QUAD_GANTRY_LEVEL
    BED_MESH_CLEAR
    Adaptive_Mesh
    M117 Full probe @ 90Â°C complete

[gcode_macro PROBE100]
description: Full hot-bed probing @ 100Â°C
gcode:
    M140 S100
    M190 S100
    _UNIBARF_COOL_FOR_PROBE
    G28 Z
    QUAD_GANTRY_LEVEL
    BED_MESH_CLEAR
    Adaptive_Mesh
    M117 Full probe @ 100Â°C complete
