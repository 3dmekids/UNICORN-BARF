# ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘      UNICORN-BARF â€” MACRO SYSTEM (2025 PRO)          â•‘
# â•‘   TAP-Safe â€¢ KAMP-Ready â€¢ Voron 2.4 (350mm)           â•‘
# â•‘   Full PRINT_START â€¢ PRINT_END â€¢ Safety â€¢ Tools      â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„ğŸ¦„


# ============================================================
# SAFE LIFT â€” Always lift Z before any risky moves
# ============================================================
[gcode_macro SAFE_LIFT]
description: Safe Z lift (default 15mm)
gcode:
    {% set L = params.Z|default(15)|float %}
    G91
    G1 Z{L} F6000
    G90


# ============================================================
# UNIVERSAL HOMING PROTECTOR
# ============================================================
[gcode_macro SAFE_HOME_IF_NEEDED]
description: Home only when required
gcode:
    {% if not printer.toolhead.homed_axes == "xyz" %}
        M117 Homing...
        G28
    {% endif %}


# ============================================================
# NOZZLE COOLING ROUTINE (TAP-SAFE)
# ============================================================
[gcode_macro _UNIBARF_COOL_FOR_PROBE]
description: Cool nozzle for TAP probing
gcode:
    M104 S0
    M106 S255
    G4 P15000
    M106 S0


# ============================================================
# SMART PARK â€” park near the print area
# ============================================================
[gcode_macro Smart_Park]
description: Park at front-middle for purge & heat
gcode:
    G90
    G1 X175 Y20 F6000
    G1 Z10 F3000


# ============================================================
# BASIC PURGE (fallback for KAMP)
# ============================================================
[gcode_macro Line_Purge]
description: Standard purge line (used when KAMP cannot)
gcode:
    M117 Purging...
    G92 E0
    G1 X20 Y5 F10000
    G1 Z0.3 F3000
    G1 X330 E20 F1000
    G92 E0


# ============================================================
# FULL PRO LEVEL PROBE
# Hot Bed â†’ Cool Nozzle â†’ QGL â†’ Adaptive Mesh
# ============================================================
[gcode_macro PROBE_WITH_HOT_BED]
description: Full TAP-safe probing + QGL + Mesh
gcode:
    {% set BED = params.BED|default(60)|float %}

    M117 Heating bed to {BED}C...
    M140 S{BED}
    M190 S{BED}

    M117 Cooling nozzle for TAP...
    _UNIBARF_COOL_FOR_PROBE

    SAFE_HOME_IF_NEEDED

    M117 QGL Running...
    QUAD_GANTRY_LEVEL

    M117 Clearing mesh...
    BED_MESH_CLEAR

    M117 Adaptive Mesh...
    Adaptive_Mesh

    M117 Probing complete.


# ============================================================
# FULL PROFESSIONAL PRINT_START (Option A)
# ============================================================
[gcode_macro PRINT_START]
description: Unicorn-Barf TAP-Safe Pro Start
gcode:
    LED_HEATING
    M117 Starting Unicorn-Barf...

    {% set BED_TEMP = params.BED|default(60)|float %}
    {% set EXT_TEMP = params.EXTRUDER|default(200)|float %}

    # TAP-safe full probe sequence
    PROBE_WITH_HOT_BED BED={BED_TEMP}

    M117 Heating nozzle...
    M109 S{EXT_TEMP}

    M117 Smart Park...
    Smart_Park

    # Purge (KAMP overrides if active)
    {% if printer.exclude_object.objects %}
        M117 Adaptive Purge...
        Voron_Purge
    {% else %}
        Line_Purge
    {% endif %}

    LED_PRINTING
    M117 Printing...


# ============================================================
# PRINT_END â€” Safe shutdown
# ============================================================
[gcode_macro PRINT_END]
description: Safe finish, park & cool
gcode:
    LED_IDLE
    M117 Finishing Print...

    G91
    G1 Z16 F6000
    G90

    G1 X175 Y350 F9000
    G1 Z50 F3000

    M104 S0
    M140 S0

    M106 S255
    G4 P8000
    M106 S0

    G92 E0

    CHIME_SUCCESS
    M117 Idle.


# ============================================================
# EMERGENCY Z-UP
# ============================================================
[gcode_macro EMERGENCY_UP]
description: Raise Z instantly (save print/TAP)
gcode:
    G91
    G1 Z25 F3000
    G90


# ============================================================
# CLEAN NOZZLE
# ============================================================
[gcode_macro CLEAN_NOZZLE]
description: Fan-blast clean nozzle
gcode:
    SAFE_HOME_IF_NEEDED
    G1 X20 Y350 Z10 F8000
    M106 S255
    G4 P3000
    M106 S0


# ============================================================
# FILAMENT LOAD / UNLOAD
# ============================================================
[gcode_macro FILAMENT_LOAD]
gcode:
    SAFE_LIFT Z=20
    M109 S200
    G92 E0
    G1 E40 F300

[gcode_macro FILAMENT_UNLOAD]
gcode:
    SAFE_LIFT Z=20
    M109 S200
    G92 E0
    G1 E-40 F300


# ============================================================
# CHIMES
# ============================================================
[gcode_macro CHIME_SUCCESS]
gcode:
    M300 S440 P200
    M300 S554 P200
    M300 S659 P400


# ============================================================
# TAP PROBE TESTING
# ============================================================
[gcode_macro PROBE_TEST]
description: TAP 10-sample center accuracy test
gcode:
    SAFE_HOME_IF_NEEDED
    G1 X175 Y175 F8000
    PROBE_ACCURACY SAMPLES=10


# ============================================================
# QGL & MESH TESTS
# ============================================================
[gcode_macro QUICK_QGL]
description: Hot-bed QGL only
gcode:
    M140 S60
    M190 S60
    _UNIBARF_COOL_FOR_PROBE
    SAFE_HOME_IF_NEEDED
    QUAD_GANTRY_LEVEL
    M117 QGL Done.

[gcode_macro MESH_SAFE]
description: Hot bed + cold nozzle + mesh
gcode:
    M140 S60
    M190 S60
    _UNIBARF_COOL_FOR_PROBE
    SAFE_HOME_IF_NEEDED
    BED_MESH_CLEAR
    Adaptive_Mesh


# ============================================================
# MOTION TESTS
# ============================================================
[gcode_macro MOVE_TEST]
description: XY motion sanity test
gcode:
    SAFE_HOME_IF_NEEDED
    G1 X10 Y10 F9000
    G1 X340 Y10 F9000
    G1 X340 Y340 F9000
    G1 X10 Y340 F9000
    G1 X175 Y175 F9000
    M117 Motion OK

[gcode_macro STEPPERS_TEST]
description: Tests XY and Z movement
gcode:
    G28
    M117 Stepper Test...
    G1 X20 Y20 Z10 F6000
    G1 X330 Y20 F9000
    G1 X330 Y330 F9000
    G1 X20 Y330 F9000
    G1 X20 Y20 F9000
    G1 Z50 F3000
    M117 Steppers OK
