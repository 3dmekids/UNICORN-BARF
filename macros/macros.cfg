# ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„
# â•‘ UNICORN-BARF 2025 PRO MACROS â€” FINAL CLEAN VERSION        â•‘
# â•‘ Voron 2.4 350mm â€¢ TAP â€¢ KAMP â€¢ Mainsail-compatible        â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„

# ============================================================
# SAFE Z LIFT (used everywhere)
# ============================================================
[gcode_macro SAFE_LIFT]
description: Lift Z a specified amount (default 15mm)
gcode:
    {% set z = params.Z|default(15)|float %}
    G91
    G1 Z{z} F6000
    G90

# ============================================================
# HOMING HELPER
# ============================================================
[gcode_macro SAFE_HOME_IF_NEEDED]
description: Home only if not already homed
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
        M117 Homing...
        G28
    {% endif %}

# ============================================================
# TAP-SAFE NOZZLE COOLING
# ============================================================
[gcode_macro _COOL_NOZZLE]
description: Cool nozzle + blast fan (TAP safe)
gcode:
    M104 S0
    M106 S255
    G4 P15000
    M106 S0

# ============================================================
# SMART PARK (front-middle for purge/heating)
# ============================================================
[gcode_macro SMART_PARK]
description: Park near print area for purge and final heating
gcode:
    G90
    G1 X175 Y20 F12000
    G1 Z10 F3000

# ============================================================
# FALLBACK PURGE LINE (when KAMP is not active)
# ============================================================
[gcode_macro LINE_PURGE]
description: Classic purge line fallback
gcode:
    M117 Purging...
    G92 E0
    G1 X20 Y5 Z0.3 F15000
    G1 X330 E25 F1200
    G92 E0

# ============================================================
# MAINSAIL-STANDARD PAUSE/RESUME/CANCEL (2025 gold standard)
# ============================================================
[gcode_macro _TOOLHEAD_PARK]
description: Helper macro for safe parking during pause/cancel
variable_park_x: 345   # back-right for 350mm bed
variable_park_y: 345
variable_retract: 1.0
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_PARK_STATE
    G91
    G1 Z10 F6000                     # lift
    G90
    G1 X{printer["gcode_macro _TOOLHEAD_PARK"].park_x} Y{printer["gcode_macro _TOOLHEAD_PARK"].park_y} F12000
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G91
        G1 E-{printer["gcode_macro _TOOLHEAD_PARK"].retract} F2100
        G90
    {% endif %}

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
description: Pause print and park in back-right corner
gcode:
    PAUSE_BASE
    _TOOLHEAD_PARK

[gcode_macro RESUME]
rename_existing: RESUME_BASE
description: Resume print
gcode:
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G91
        G1 E{printer["gcode_macro _TOOLHEAD_PARK"].retract} F2100
        G90
    {% endif %}
    RESTORE_GCODE_STATE NAME=PAUSE_PARK_STATE MOVE=1 MOVE_SPEED=100
    RESUME_BASE

[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
description: Cancel print safely
gcode:
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    G91
    G1 Z20 F6000
    G90
    G1 X175 Y350 F12000
    M106 S0
    CANCEL_PRINT_BASE

# ============================================================
# FULL PRINT_START (KAMP-aware, TAP-safe)
# ============================================================
[gcode_macro PRINT_START]
description: Unicorn-Barf Pro Print Start 2025
gcode:
    LED_HEATING
    M117 Unicorn-Barf Starting...
    {% set BED = params.BED|default(60)|float %}
    {% set HOTEND = params.EXTRUDER|default(210)|float %}

    # Heat bed + full TAP-safe probing sequence
    M140 S{BED}
    M190 S{BED}
    _COOL_NOZZLE
    SAFE_HOME_IF_NEEDED
    QUAD_GANTRY_LEVEL
    BED_MESH_CLEAR
    {% if printer.exclude_object.objects|length > 0 %}
        Adaptive_Mesh
    {% else %}
        BED_MESH_CALIBRATE
    {% endif %}

    # Final nozzle heat
    M109 S{HOTEND}

    # Smart park + purge
    SMART_PARK
    {% if printer.exclude_object.objects|length > 0 %}
        Voron_Purge
    {% else %}
        LINE_PURGE
    {% endif %}

    LED_PRINTING
    M117 Printing!

# ============================================================
# PRINT_END (rear park + chime)
# ============================================================
[gcode_macro PRINT_END]
description: Safe print finish
gcode:
    LED_IDLE
    M117 Print Finished!
    SAVE_GCODE_STATE NAME=PRINT_END_STATE
    G91
    G1 Z20 F6000
    G90
    G1 X175 Y350 F12000
    G1 Z{printer.toolhead.axis_maximum.z - 20} F3000
    TURN_OFF_HEATERS
    M106 S255
    G4 P8000
    M106 S0
    G92 E0
    CHIME_SUCCESS
    RESTORE_GCODE_STATE NAME=PRINT_END_STATE
    M117 Idle

# ============================================================
# FUN & UTILITY MACROS (kept because they're awesome)
# ============================================================
[gcode_macro EMERGENCY_UP]
description: Instant Z+25mm (save the print!)
gcode:
    G91
    G1 Z25 F3000
    G90

[gcode_macro CLEAN_NOZZLE]
description: Blast-clean nozzle
gcode:
    SAFE_HOME_IF_NEEDED
    G1 X20 Y350 Z10 F12000
    M106 S255
    G4 P3000
    M106 S0

[gcode_macro FILAMENT_LOAD]
gcode:
    SAFE_LIFT Z=20
    M109 S200
    G92 E0
    G1 E50 F300

[gcode_macro FILAMENT_UNLOAD]
gcode:
    SAFE_LIFT Z=20
    M109 S200
    G92 E0
    G1 E-60 F1800

[gcode_macro CHIME_SUCCESS]
gcode:
    M300 S440 P200
    M300 S554 P200
    M300 S659 P400

# ============================================================
# TEST MACROS (keep these â€“ theyâ€™re gold)
# ============================================================
[gcode_macro PROBE_TEST]
description: TAP accuracy test at center
gcode:
    SAFE_HOME_IF_NEEDED
    G1 X175 Y175 Z10 F12000
    PROBE_ACCURACY SAMPLES=10

[gcode_macro QUICK_QGL]
description: Fast QGL at 60Â°C
gcode:
    M140 S60
    M190 S60
    _COOL_NOZZLE
    SAFE_HOME_IF_NEEDED
    QUAD_GANTRY_LEVEL

[gcode_macro MOVE_TEST]
description: Full XY travel test
gcode:
    SAFE_HOME_IF_NEEDED
    G1 X10 Y10 F15000
    G1 X340 Y10
    G1 X340 Y340
    G1 X10 Y340
    G1 X175 Y175
    M117 Motion OK