# ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘           UNICORN-BARF PRINT_START SYSTEM           â•‘
# â•‘  TAP â€¢ KAMP â€¢ Smart Park â€¢ Hot Bed â€¢ Cold Nozzle    â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„ðŸ¦„


# ============================================================
# FORCE COLD NOZZLE FOR TAP PROBING
# Prevents false triggers and protects sensor
# ============================================================
[gcode_macro _UNIBARF_COOL_FOR_PROBE]
description: Force nozzle to cold-state before TAP probing
gcode:
    M104 S0
    M106 S255
    G4 P8000
    M106 S0


# ============================================================
# PROBE WITH HOT BED (TAP-safe)
# 1. Heat bed
# 2. Cool nozzle
# 3. Home
# 4. QGL
# 5. Clear mesh
# 6. KAMP Adaptive Mesh
# ============================================================
[gcode_macro PROBE_WITH_HOT_BED]
description: Hot bed + cold nozzle + QGL + Adaptive Mesh (TAP safe)
gcode:
    {% set BED = params.BED|default(60)|float %}

    M117 Heating bed...
    M140 S{BED}
    M190 S{BED}

    M117 Cooling nozzle for TAP...
    _UNIBARF_COOL_FOR_PROBE

    M117 Homing...
    G28

    M117 QGL...
    QUAD_GANTRY_LEVEL

    M117 Clearing mesh...
    BED_MESH_CLEAR

    M117 Adaptive Mesh (KAMP)...
    Adaptive_Mesh


# ============================================================
# FULL PRINT_START â€” UNICORN BARF PRO 2025
# ============================================================
[gcode_macro PRINT_START]
description: Unicorn-Barf Professional Print Start (TAP + KAMP + FX)
gcode:
    M117 Starting Print...
    LED_HEATING

    # User parameters
    {% set BED_TEMP = params.BED|default(60)|float %}
    {% set EXT_TEMP = params.EXTRUDER|default(200)|float %}

    # ---- Bed heating & TAP workflow ----
    PROBE_WITH_HOT_BED BED={BED_TEMP}

    # ---- Final nozzle warmup ----
    M117 Heating nozzle...
    M109 S{EXT_TEMP}

    # ---- Smart Park ----
    M117 Smart Park...
    Smart_Park

    # ---- Purging logic (KAMP-aware) ----
    M117 Purging...
    {% if printer.exclude_object.objects|length > 0 %}
        Voron_Purge
    {% else %}
        Line_Purge
    {% endif %}

    LED_PRINTING
    M117 Printing...


# END OF PRINT_START
